import{_ as n,o as s,c as a,N as p}from"./chunks/framework.79b88b02.js";const F=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"docs/ResetInputPosition.md","lastUpdated":1696650276000}'),t={name:"docs/ResetInputPosition.md"},o=p(`<h2 id="输入框不在可视范围" tabindex="-1">输入框不在可视范围 <a class="header-anchor" href="#输入框不在可视范围" aria-label="Permalink to &quot;输入框不在可视范围&quot;">​</a></h2><p>方法名：<code>ResetInputPosition</code></p><div class="language-ts"><pre><code>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ResetInputPosition</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> instance
    <span class="token keyword">static</span> AndroidIsInit <span class="token operator">=</span> <span class="token boolean">false</span>
    inputDom<span class="token operator">:</span> HTMLInputElement
    androidScrollParent<span class="token operator">:</span> HTMLElement
    lastHeight<span class="token operator">:</span> <span class="token builtin">number</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span>inputDom<span class="token punctuation">,</span> androidScrollParent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>inputDom <span class="token operator">=</span> inputDom
      <span class="token keyword">this</span><span class="token punctuation">.</span>androidScrollParent <span class="token operator">=</span> androidScrollParent
      <span class="token keyword">this</span><span class="token punctuation">.</span>lastHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ResetInputPosition<span class="token punctuation">.</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ResetInputPosition<span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> ResetInputPosition<span class="token punctuation">.</span>instance
    <span class="token punctuation">}</span>
  
    <span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ios情况下</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">iphone|ipad|ipod|ios</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inputDom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;focusin&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onFocusPage<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>androidScrollParent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ResetInputPosition<span class="token punctuation">.</span>AndroidIsInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ResetInputPosition<span class="token punctuation">.</span>AndroidIsInit <span class="token operator">=</span> <span class="token boolean">true</span>
        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;resize&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleAndroidResize<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
    <span class="token function-variable function">onFocusPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleCalcScrollTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  
    <span class="token function-variable function">handleAndroidResize</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> resizeHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastHeight <span class="token operator">-</span> window<span class="token punctuation">.</span>innerHeight <span class="token comment">// 本次变动量</span>
      <span class="token comment">// 弹出软键盘</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>resizeHeight <span class="token operator">&gt;</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleCalcScrollTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
    <span class="token function-variable function">handleCalcScrollTop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> scrollObj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>androidScrollParent <span class="token operator">||</span> window<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>HTMLElement <span class="token operator">|</span> Window<span class="token punctuation">)</span>
      <span class="token keyword">let</span> screenHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight
      screenHeight <span class="token operator">=</span> screenHeight <span class="token operator">-</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastHeight <span class="token operator">===</span> screenHeight<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">300</span> <span class="token comment">// ios15弹窗出现window.innerHeight 不会改变，导致输入框被遮住</span>
      <span class="token keyword">var</span> currentInputTop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputDom<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top
      <span class="token comment">// 已经偏移（滚动）的量</span>
      <span class="token keyword">const</span> yOffset <span class="token operator">=</span> scrollObj <span class="token operator">===</span> window <span class="token operator">?</span> window<span class="token punctuation">.</span>pageYOffset <span class="token operator">:</span> <span class="token punctuation">(</span>scrollObj <span class="token keyword">as</span> HTMLElement<span class="token punctuation">)</span><span class="token punctuation">.</span>scrollTop
      <span class="token comment">// 不在可视视口中</span>
      <span class="token comment">// 被软键盘遮住</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentInputTop <span class="token operator">&gt;</span> screenHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scrollObj<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> yOffset <span class="token operator">+</span> currentInputTop <span class="token operator">-</span> screenHeight <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputDom<span class="token punctuation">.</span>offsetHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token comment">// 滚上去了可视视口，被视口遮住</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentInputTop <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scrollObj<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> yOffset <span class="token operator">-</span> currentInputTop <span class="token operator">-</span> screenHeight <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputDom<span class="token punctuation">.</span>offsetHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  </code></pre><p>methods/ResetInputPosition</p></div><h2 id="解释文档" tabindex="-1">解释文档 <a class="header-anchor" href="#解释文档" aria-label="Permalink to &quot;解释文档&quot;">​</a></h2><h3 id="问题原因" tabindex="-1">问题原因 <a class="header-anchor" href="#问题原因" aria-label="Permalink to &quot;问题原因&quot;">​</a></h3><ul><li>当软键盘出现后，可视视口变短了，原本出现在可视视口的内容就会被部分内容被遮挡住，为什么输入框还可以看到，因为原生帮我们移动了容器的位置，让聚焦的输入框能够展示在界面上。但是尽管如此，也存在调整不到位的情况，而且是偶现。</li><li>使用了第三方键盘，原生监听不到键盘的出现。</li><li>ios15以上会出现可视视口没有压缩，导致输入框被遮挡。</li></ul><h3 id="原生调整方案" tabindex="-1">原生调整方案 <a class="header-anchor" href="#原生调整方案" aria-label="Permalink to &quot;原生调整方案&quot;">​</a></h3><ul><li>安卓：Android会依次从当前最顶层有滚动条的视图上进行调整，以让输入框能够展示在可视范围内，即如果最顶层滚动了还不足以显示，则滚动次顶视图的，依次自顶向下调整滚动；</li><li>IOS：先平移webview，当平移完发现还不足以展示，若webview自身也有滚动条，则也会滚动webview内容</li></ul><h3 id="思路" tabindex="-1">思路 <a class="header-anchor" href="#思路" aria-label="Permalink to &quot;思路&quot;">​</a></h3><ol><li>监听到出现软键盘</li><li>手动干预滚动需要的的条件</li><li>用脚本调整到适当位置</li></ol><h4 id="监听出现软键盘" tabindex="-1">监听出现软键盘 <a class="header-anchor" href="#监听出现软键盘" aria-label="Permalink to &quot;监听出现软键盘&quot;">​</a></h4><ul><li>IOS: 聚焦，软键盘出现，失焦，软键盘消失。--- focus</li><li>安卓：聚焦，软键盘出现，失焦，软键盘消失。软键盘的“完成”“收起”点击了，界面还是聚焦状态。所以不能用focus，考虑到webview变短了，即会触发resize事件。resize事件是充分非必要条件，webview变短，resize触发；resize触发，webview不一定变短。所以考虑resize变化的大小，大于200px的才视为软键盘弹出。</li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">iphone</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">ipad</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">ipod</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">ios</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#A6ACCD;">(navigator</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">userAgent)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">inputDom</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">focusin</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">setTimeout</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">clearTimeout</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">timer</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">handleCalcScrollTop</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">300</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">androidScrollParent </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">ResetInputPosition</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">AndroidIsInit) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resizeHeight</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">lastHeight</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">window</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">innerHeight</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 本次变动量</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// 弹出软键盘</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">resizeHeight</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">setTimeout</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">handleCalcScrollTop</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">150</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="手动干预滚动需要的的条件" tabindex="-1">手动干预滚动需要的的条件 <a class="header-anchor" href="#手动干预滚动需要的的条件" aria-label="Permalink to &quot;手动干预滚动需要的的条件&quot;">​</a></h4><p><img src="https://ltf.yijiesudai.com/online/20230911/271fceecd44ef4dd.png" alt=""></p><ul><li>手动滚动的条件：</li><li>1.当前input元素在视口上面：input.getBoundingClientRect().top &lt; 0</li><li>1.当前input元素在视口下面：input.getBoundingClientRect().top &gt; window.innerHeight（视口的高度）</li></ul><h4 id="计算滚动距离" tabindex="-1">计算滚动距离 <a class="header-anchor" href="#计算滚动距离" aria-label="Permalink to &quot;计算滚动距离&quot;">​</a></h4><p><img src="https://ltf.yijiesudai.com/online/20230911/271fceecd44ef4dd.png" alt=""></p><ul><li>输入框1：向上滚动到可视视口顶部，再向下滚动到可视时刻高度的一半位置，此时顶部位置才是可视视口的中间位置，所以向上滚动到自身高度一半。</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">input.getBoundingClientRect().top - window.innerHeight.height / 2 + input.offsetHeight / 2</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><ul><li>输入框2：向下滚动到可视视口顶部，再向下滚动到可视时刻高度的一半位置，此时顶部位置才是可视视口的中间位置，所以向上滚动到自身高度一半。</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">-input.getBoundingClientRect().top - window.innerHeight.height / 2 + input.offsetHeight / 2</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div>`,22),e=[o];function l(c,i,r,u,k,d){return s(),a("div",null,e)}const h=n(t,[["render",l]]);export{F as __pageData,h as default};
